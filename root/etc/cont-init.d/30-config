#!/usr/bin/with-contenv bash

if [ -d /app/projectsend-tmp ]; then
    echo "New container detected. Setting up app folder and fixing permissions."
    mv /app/projectsend-tmp /app/projectsend
    chown -R abc:abc /app
fi

# set default values for variables
PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-512M}
MAX_UPLOAD=${MAX_UPLOAD:-5000}
PHP_MAX_FILE_UPLOAD=${PHP_MAX_FILE_UPLOAD:-200}
USABLE_MAX_UPLOAD=${MAX_UPLOAD//[!0-9]/}

# create our folders
mkdir -p \
    /config/projectsend \
    /data/projectsend

# configure php
sed -i \
    -e "s#;*memory_limit =.*#memory_limit = ${PHP_MEMORY_LIMIT}#i" \
    -e "s#;*upload_max_filesize =.*#upload_max_filesize = ${USABLE_MAX_UPLOAD}M#i" \
    -e "s#;*max_file_uploads =.*#max_file_uploads = ${PHP_MAX_FILE_UPLOAD}#i" \
    -e "s#;*post_max_size =.*#post_max_size = ${USABLE_MAX_UPLOAD}M#i" \
    -e "s#;*cgi.fix_pathinfo=.*#cgi.fix_pathinfo= 0#i" \
        /etc/php7/php.ini

if ! grep -q 'config-v1' /config/nginx/site-confs/default; then
    cp /defaults/default /config/nginx/site-confs
fi

# copy config
PREV_DIR=$(pwd)

cd /defaults/upload || exit
shopt -s globstar nullglob
shopt -s dotglob
    for i in *
    do
        if [ ! -e "/data/projectsend/${i}" ] ; then
        cp -R "${i}" "/data/projectsend/${i}"
        chown abc:abc "/data/projectsend/${i}"
        fi
    done

shopt -u globstar nullglob
shopt -u dotglob

cd "${PREV_DIR}" || exit

# create symlinks
[[ ! -L /app/projectsend/upload ]] && \
    ln -sf /data/projectsend /app/projectsend/upload

[[ -f /app/projectsend/includes/sys.config.php ]] && \
    rm /app/projectsend/includes/sys.config.php
[[ ! -L /app/projectsend/includes/sys.config.php ]] && \
    ln -sf /config/projectsend/sys.config.php /app/projectsend/includes/sys.config.php

# symlink translations
mkdir -p /config/translations

shopt -s globstar dotglob

[[ -d /config/translations/lang && ! -L /app/projectsend/lang  ]] && rm -rf /app/projectsend/lang
[[ ! -d /config/translations/lang && ! -L /app/projectsend/lang  ]] && mv /app/projectsend/lang /config/translations/
[[ -d /config/translations/lang && ! -L /app/projectsend/lang  ]] && ln -s /config/translations/lang /app/projectsend/lang

symlinks=( \
/app/projectsend/templates/default/lang \
/app/projectsend/templates/gallery/lang \
/app/projectsend/templates/pinboxes/lang \
)

for i in "${symlinks[@]}"; do
[[ -d /config/translations/"$(echo $i | awk -F '/' '{print $(NF-1)"/"$NF}')" && ! -L "$i"  ]] && rm -rf "$i"
[[ ! -d /config/translations/"$(echo $i | awk -F '/' '{print $(NF-1)"/"$NF}')" && ! -L "$i"  ]] && mv "$i" /config/translations/"$(echo $i | awk -F '/' '{print $(NF-1)}')"
[[ -d /config/translations/"$(echo $i | awk -F '/' '{print $(NF-1)"/"$NF}')" && ! -L "$i"  ]] && ln -s /config/translations/"$(echo $i | awk -F '/' '{print $(NF-1)"/"$NF}')" "$i"
done

shopt -u globstar dotglob

# permissions
echo "Fixing app data permissions."
chown abc:abc \
    /data/projectsend
chown -R abc:abc \
    /config
